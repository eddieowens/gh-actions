on:
  workflow_call:
    inputs:
      test-dirs:
        description: Space-separated list of directories to test
        required: false
        default: ./
        type: string
      ref-name:
        description: The name of the branch to calculate coverage
        required: false
        default: ''
        type: string
      go-cover-path:
        description: The path to the coverage file generated in the test
        required: false
        default: ./cover.out
        type: string
      threshold-file:
        description: The threshold for a singular file
        required: false
        default: '-1'
        type: string
      threshold-package:
        description: The threshold for a singular package
        required: false
        default: '-1'
        type: string
      threshold-total:
        description: The threshold required for the entire repo
        required: false
        default: '70'
        type: string
    secrets: inherit

env:
  ACTIONS_REPO: skiff-sh/actions
  ACTIONS_PATH: ./skiff-actions

jobs:
  go-test:
    name: Go test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        name: Checkout Skiff actions
        with:
          repository: '${{ env.ACTIONS_REPO }}'
          path: '${{ env.ACTIONS_PATH }}'
      - uses: ./actions/go
        name: Setup go
      - uses: ./actions/go-test
        with:
          dirs: ${{ inputs.dirs }}
      - uses: ./actions/go-coverage
        with:
          ref-name: ${{ inputs.ref-name }}
          go-cover-path: ${{ inputs.go-cover-path }}
          threshold-file: ${{ inputs.threshold-file }}
          threshold-package: ${{ inputs.threshold-package }}
          threshold-total: ${{ inputs.threshold-total }}
          gh-token: ${{ secrets.BOT_TOKEN }}

